import requests
import json
import sys
import time


apikey = "4d8186d5f33938ebf6f639a630d56da64ac57c93c6c2d6c6f57d870dfdd5ccae"
base_url = "https://www.virustotal.com/api/v3/urls"
analysis_url = "https://www.virustotal.com/api/v3/analyses/"
urls_to_scan = ["http://42.225.205.210:56879/i"]

results_list = []

def scan_url (api_key, urls_to_scan, base_api_url, analysis_api_url):

    for url in urls_to_scan:
        
        #Scan for the url id
        id_response = scan_api(api_key, url, base_api_url)
        scan_json = json.loads(id_response.text)
        url_id = scan_json['data']['id']


        #Queries the url analysis
        analysis_api(api_key, url_id, analysis_api_url, True)
        time.sleep(10)
        #Gets the url analysis object back
        #This is the nature of the api, i'm sure there's a way around this, but this is how i'm doing that
        analysis_response = analysis_api(api_key, url_id, analysis_api_url)
        scan_response_json = json.loads(analysis_response.text)

        #Checks if any of the virus scanner picked up any malicious or suspicious activity on the url
        mal_list = []
        sus_list = []
        if scan_response_json['data']['attributes']['stats']['malicious'] > 0 or scan_response_json['data']['attributes']['stats']['suspicious'] > 0:
            mal_list, sus_list = get_scan_methods(scan_response_json)
        else:
            print(f"Scans found no malicious or suspicious flags for {url}")

        #time.sleep(25)
        results_dict = {"scanned_url" : scan_response_json['meta']['url_info']['url'], 
                        "harmless" : scan_response_json['data']['attributes']['stats']['harmless'],
                        "malicious" : scan_response_json['data']['attributes']['stats']['malicious'],
                        "enginesFoundMalicious" : mal_list,
                        "suspicious" : scan_response_json['data']['attributes']['stats']['suspicious'],
                        "enginesFoundSuspicious" : sus_list,
                        "undetected" : scan_response_json['data']['attributes']['stats']['undetected'],
                        "timeout" : scan_response_json['data']['attributes']['stats']['timeout']
                        }
        print(analysis_response.text)
        results_list.append(results_dict)


def get_scan_methods(json_object):
    malicious_list = []
    suspicious_list = []
    for result in json_object['data']['attributes']['results']:
        if json_object['data']['attributes']['results'][f'{result}']['category'] == "malicious":
            malicious_list.append(json_object['data']['attributes']['results'][result]['engine_name'])        

        if json_object['data']['attributes']['results'][f'{result}']['category'] == "suspicious":
            suspicious_list.append(json_object['data']['attributes']['results'][result]['engine_name'])
     
    return malicious_list, suspicious_list

#Gets the url_id to be passed into the analysis endpoint
def scan_api(api_key, url, base_api_url):
    payload = { "url": url }
    headers = {
        "accept": "application/json",
        "x-apikey": apikey,
        "content-type": "application/x-www-form-urlencoded"
    }
    response = requests.post(base_api_url, data=payload, headers=headers)
    return response

#Gets the analysis for the url
def analysis_api(api_key, url_id, analysis_api_url, query_flag=False):
    if query_flag == True:
        print("Querying url...")
        return
    else:
        analysis_headers = {
                "accept": "application/json",
                "x-apikey": api_key
            }
        analysis_url_and_id = analysis_api_url + url_id
        analysis_response = requests.get(analysis_url_and_id, headers=analysis_headers)
        return analysis_response



scan_url(apikey, urls_to_scan, base_url, analysis_url)
print(results_list)